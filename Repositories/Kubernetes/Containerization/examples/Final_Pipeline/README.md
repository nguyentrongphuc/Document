# Purpose of This Repo

This repos has a sample "Hello World" flask application that we will deploy on EKS cluster using the AWS Codebuild and Codepipeline services. 
Here is the purpose of each file present in this repo:
```bash

├── app.py         # A sample "Hello World" flask application
├── ci-cd-codepipeline.cfn.yml # Cloudformation template to create the Codebuild, and Codepipeline, and related resources. 
├── buildspec.yml  # Codebuild will execute the commands available here. 
├── Dockerfile     # Codebuild will build an image using the Dockerfile, and push it to the Dockerhub/or AWS ECR. 
├── deployment.yml # The deployment file for the Kubernetes cluster. Codebuild will apply this deployment using the one of the kubectl commands.   
├── iam-role-policy.json # The Policy for the IAM role that the Codebuild will assume
├── trust.json # The trusted entity details for the  IAM role that the COdebuild will assume
└── aws-auth-patch.yml  # This is an autogenerated file for your reference. 
```



## Run the app on AWS Cloud
The steps you will follow are:
1. **Create an EKS Cluster, IAM Role for CodeBuild, and Authenticate the CodeBuild**<br>
You will start with creating an EKS cluster in your preferred region, using `eksctl` command. Then, you will create an IAM role that the Codebuild will assume to access your k8s/EKS cluster. This IAM role will have the necessary access permissions (attached JSON policies), and you will also have to add this role to the k8s cluster's configMap. <br><br>


2. **Deployment to Kubernetes using CodePipeline and CodeBuild**
 - **Generate a Github access token**<br>Next, you will generate an access-token from your Github account so that whichever service has that token can access the repositories from your Github account. You will share this token with the AWS Codebuild service (programmatically) so that it can build and test your code. <br><br>
 
 - **Create Codebuild and CodePipeline resources using CloudFormation template**<br>Create a pipeline watching for commits to your Github repository. You will create the necessary AWS resources using a script, Cloudformation template (.yaml) file, available to you. These resources collectively are called **stack**. It will automatically create the Codebuild and Codepipeline projects for you. <br><br>
 
 
 - **Build and deploy**<br>Finally, you will trigger the **build** based on a Github commit. 


# Pipeline
## Create an IAM Role for Code Build

### 1. Create an EKS Cluster

Create Kubernetes cluster, eksctl-demo using the command below:

`eksctl create cluster --name eksctl-demo --nodes=2 --version=1.22 --instance-types=t2.medium --region=us-east-2`

The `eksctl` command will automatically configure the local kubeconfig file so that you can communicate with the newly created cluster as:

```bash
## Check the status, Nodes should be ready
kubectl get nodes
```
### 2. Create an IAM Role for CodeBuild
Can the CodedBuild service access and see the details of your existing EKS cluster? **The answer is NO!**

Therefore, having your CodeBuild service communicate with the EKS cluster will require:

- **Authenticate the CodeBuild:** Create an IAM role that the CodeBuild will assume. This IAM role will have two components:
    + **Trust relationship**: You (the root user) will "trust" the CodeBuild service, which will assume this IAM role.
    + **Policies**: You will mention the set of permissible actions that the Codebuild can perform, such as viewing the details of the EKS cluster.
- **Authorize the CodeBuild:** After creating the IAM role, the authorization step is done at the EKS end. EKS has an RBAC system that allows new roles access to the cluster. The RBAC details are present in a ConfigMap (YAML file) where you will add the details of the new IAM role.

Let's create an IAM role for authenticating the Codebuild. Creating an IAM role has two components:

#### 2.1. Create a Trust relationship
We can define the [Trust relationship](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-user.html) in the form of a JSON file. However, we have given this file, trust.json, for your convenience. At this point, it is essential to understand two terms:

Trusting account: the resource owner (EKS cluster). In our example, it is YOU because you've created the EKS cluster. We will mention the details of the Trusting account in the trust.json.
Trusted account: the entity/service who will assume the role to need access to the resource (EKS cluster). In our example, it is the CodeBuild service.
Here are the steps to create a Trust relationship:

Find your AWS account ID using the command:
aws sts get-caller-identity --query Account --output text
## Returns the AWS account id similar to 
## 519002666132
Update the trust.json file with your AWS account id.
{
"Version": "2012-10-17",
"Statement": [
    {
        "Effect": "Allow",
        "Principal": {
            "AWS": "arn:aws:iam::<ACCOUNT_ID>:root"
        },
        "Action": "sts:AssumeRole"
    }
]
}
Replace the <ACCOUNT_ID> with your actual AWS account ID. Reference: Creating a role to delegate permissions to an IAM user


## Authorize Code Build using EKS RBAC

## Deploy to EKS cluster